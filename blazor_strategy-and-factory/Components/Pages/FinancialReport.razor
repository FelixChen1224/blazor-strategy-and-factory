@page "/financial-report"
@rendermode InteractiveServer
@using blazor_strategy_and_factory.Models
@using blazor_strategy_and_factory.Services.Factory
@using blazor_strategy_and_factory.Services.DataSources
@using blazor_strategy_and_factory.Services.OutputComponents
@using blazor_strategy_and_factory.Services
@inject IPageFactory PageFactory
@inject IDataSourceService DataSourceService
@inject IOutputComponentService OutputComponentService
@inject FinancialAnalysisService FinancialAnalysisService
@inject OracleSimulationService OracleSimulationService

<PageTitle>é‡‘èè³‡è¨Šæ‘˜è¦ç³»çµ±</PageTitle>

<div class="container-fluid">
    <div class="row">
        <!-- å·¦å´è¨­å®šé¢æ¿ -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š è¨­å®šé¢æ¿</h5>
                </div>
                <div class="card-body">
                    <!-- åŸºæœ¬è³‡è¨Šè¼¸å…¥ -->
                    <div class="mb-3">
                        <label class="form-label">å“¡å·¥è™Ÿç¢¼</label>
                        <input type="text" class="form-control" @bind="request.EmployeeId" placeholder="ä¾‹å¦‚: E001, E002, E003" />
                        <div class="form-text">ç¯„ä¾‹: E001 (ç‹å°æ˜), E002 (æç¾éº—), E003 (å¼µå¿—å¼·)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">å€åŸŸ</label>
                        <select class="form-select" @bind="request.Region">
                            <option value="">è«‹é¸æ“‡å€åŸŸ</option>
                            <option value="å°åŒ—">å°åŒ—</option>
                            <option value="æ–°ç«¹">æ–°ç«¹</option>
                            <option value="å°ä¸­">å°ä¸­</option>
                            <option value="é«˜é›„">é«˜é›„</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" class="form-control" @bind="request.StartDate" />
                        <div class="form-text">å»ºè­°ç¯„åœ: 2020-01-01 è‡³ 2024-12-31</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">çµæŸæ—¥æœŸ</label>
                        <input type="date" class="form-control" @bind="request.EndDate" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">æç¤ºè©</label>
                        <textarea class="form-control" rows="3" @bind="request.Prompt" placeholder="ä¾‹å¦‚: é¡¯ç¤ºè–ªè³‡ç¸½é¡ã€åˆ†æå“¡å·¥åˆ†ä½ˆã€çµ±è¨ˆäº¤æ˜“è¨˜éŒ„ç­‰"></textarea>
                    </div>
                    
                    <!-- è³‡æ–™æºé¸æ“‡ -->
                    <div class="mb-3">
                        <label class="form-label">è³‡æ–™è¡¨é¸æ“‡</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="datasource-employee" @bind="employeeSelected" />
                            <label class="form-check-label" for="datasource-employee">
                                <i class="bi bi-person-badge"></i> å“¡å·¥è³‡æ–™ (EMPLOYEES)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="datasource-financial" @bind="financialSelected" />
                            <label class="form-check-label" for="datasource-financial">
                                <i class="bi bi-currency-dollar"></i> è²¡å‹™è¨˜éŒ„ (FINANCIAL_RECORDS)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="datasource-announcement" @bind="announcementSelected" />
                            <label class="form-check-label" for="datasource-announcement">
                                <i class="bi bi-megaphone"></i> å…¬å¸é‡è¨Š (COMPANY_ANNOUNCEMENTS)
                            </label>
                        </div>
                    </div>
                    
                    <!-- è¼¸å‡ºå…ƒä»¶é¸æ“‡ -->
                    <div class="mb-3">
                        <label class="form-label">è¼¸å‡ºå…ƒä»¶</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="output-sql" @bind="sqlSelected" />
                            <label class="form-check-label" for="output-sql">
                                <i class="bi bi-code-square"></i> SQLæŸ¥è©¢èªå¥
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="output-table" @bind="tableSelected" />
                            <label class="form-check-label" for="output-table">
                                <i class="bi bi-table"></i> è³‡æ–™è¡¨æ ¼
                            </label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="output-summary" @bind="summarySelected" />
                            <label class="form-check-label" for="output-summary">
                                <i class="bi bi-file-earmark-text"></i> æ‘˜è¦å ±å‘Š
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary w-100" @onclick="GenerateReport" disabled="@isGenerating">
                        @if (isGenerating)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span>ç”Ÿæˆä¸­...</span>
                        }
                        else
                        {
                            <span>ğŸš€ ç”Ÿæˆå ±è¡¨</span>
                        }
                    </button>
                    
                    <!-- æ¸¬è©¦æŒ‰éˆ• -->
                    <button class="btn btn-info w-100 mt-2" @onclick="TestDataSources" disabled="@isGenerating">
                        ğŸ” æ¸¬è©¦è³‡æ–™æº
                    </button>
                    
                    @if (!string.IsNullOrEmpty(testResults))
                    {
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6>æ¸¬è©¦çµæœï¼š</h6>
                            <pre class="small">@testResults</pre>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <!-- å³å´å ±è¡¨é¡¯ç¤ºå€åŸŸ -->
        <div class="col-md-9">
            <!-- AIåˆ†æçµæœé¡¯ç¤º -->
            @if (analysisResult != null)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>ğŸ¤– AI é‡‘èåˆ†æå ±å‘Š - å“¡å·¥ @analysisResult.Employee?.EmployeeName (@analysisResult.Employee?.EmployeeId)</h5>
                        <small class="text-muted">ç”Ÿæˆæ™‚é–“: @analysisResult.GeneratedAt.ToString("yyyy-MM-dd HH:mm:ss")</small>
                    </div>
                    <div class="card-body">
                        <!-- å“¡å·¥åŸºæœ¬è³‡è¨Š -->
                        @if (analysisResult.Employee != null)
                        {
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6>ğŸ‘¤ å“¡å·¥åŸºæœ¬è³‡è¨Š</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>å§“å:</strong> @analysisResult.Employee.EmployeeName</li>
                                        <li><strong>éƒ¨é–€:</strong> @analysisResult.Employee.Department</li>
                                        <li><strong>è·ä½:</strong> @analysisResult.Employee.Position</li>
                                        <li><strong>å€åŸŸ:</strong> @analysisResult.Employee.Region</li>
                                        <li><strong>è–ªè³‡:</strong> @analysisResult.Employee.Salary.ToString("C")</li>
                                        <li><strong>åˆ°è·æ—¥æœŸ:</strong> @analysisResult.Employee.HireDate.ToString("yyyy-MM-dd")</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>ğŸ“Š æŠ•è³‡çµ±è¨ˆ</h6>
                                    @if (analysisResult.InvestmentStatistics != null)
                                    {
                                        <ul class="list-unstyled">
                                            <li><strong>ç¸½æŠ•è³‡é‡‘é¡:</strong> @analysisResult.InvestmentStatistics.TotalInvestment.ToString("C")</li>
                                            <li><strong>ç¸½è³£å‡ºé‡‘é¡:</strong> @analysisResult.InvestmentStatistics.TotalDivestment.ToString("C")</li>
                                            <li><strong>æ·¨æŠ•è³‡é‡‘é¡:</strong> @analysisResult.InvestmentStatistics.NetInvestment.ToString("C")</li>
                                            <li><strong>äº¤æ˜“æ¬¡æ•¸:</strong> @analysisResult.InvestmentStatistics.TransactionCount</li>
                                            <li><strong>å¹³å‡äº¤æ˜“é‡‘é¡:</strong> @analysisResult.InvestmentStatistics.AverageTransactionAmount.ToString("C")</li>
                                            <li><strong>æŠ•è³‡è‚¡ç¥¨:</strong> @string.Join(", ", analysisResult.InvestmentStatistics.StockCodes)</li>
                                        </ul>
                                    }
                                </div>
                            </div>
                        }
                        
                        <!-- AIæŠ•è³‡æ‘˜è¦ -->
                        @if (!string.IsNullOrEmpty(analysisResult.InvestmentSummary))
                        {
                            <div class="alert alert-info mb-3">
                                <h6>ğŸ’¡ AI æŠ•è³‡æ‘˜è¦</h6>
                                <p class="mb-0">@analysisResult.InvestmentSummary</p>
                            </div>
                        }
                        
                        <!-- å®Œæ•´AIåˆ†æ -->
                        @if (!string.IsNullOrEmpty(analysisResult.AIAnalysis))
                        {
                            <div class="alert alert-primary">
                                <h6>ğŸ” è©³ç´°AIåˆ†æ</h6>
                                <div style="white-space: pre-line;">@analysisResult.AIAnalysis</div>
                            </div>
                        }
                        
                        <!-- è²¡å‹™è¨˜éŒ„è¡¨æ ¼ -->
                        @if (analysisResult.FinancialRecords.Any())
                        {
                            <div class="mt-4">
                                <h6>ğŸ’° è²¡å‹™äº¤æ˜“è¨˜éŒ„</h6>
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>æ—¥æœŸ</th>
                                                <th>è‚¡ç¥¨ä»£è™Ÿ</th>
                                                <th>å…¬å¸åç¨±</th>
                                                <th>äº¤æ˜“é¡å‹</th>
                                                <th>æ•¸é‡</th>
                                                <th>æ¯è‚¡åƒ¹æ ¼</th>
                                                <th>ç¸½é‡‘é¡</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var record in analysisResult.FinancialRecords)
                                            {
                                                <tr>
                                                    <td>@record.RecordDate.ToString("yyyy-MM-dd")</td>
                                                    <td>@record.StockCode</td>
                                                    <td>@record.CompanyName</td>
                                                    <td>
                                                        <span class="badge @(record.TransactionType == "è²·å…¥" ? "bg-success" : "bg-danger")">
                                                            @record.TransactionType
                                                        </span>
                                                    </td>
                                                    <td>@record.Quantity</td>
                                                    <td>@record.PricePerShare.ToString("C")</td>
                                                    <td>@record.Amount.ToString("C")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                        
                        <!-- ç›¸é—œå…¬å¸é‡è¨Š -->
                        @if (analysisResult.CompanyAnnouncements.Any())
                        {
                            <div class="mt-4">
                                <h6>ğŸ“¢ ç›¸é—œå…¬å¸é‡è¨Š</h6>
                                @foreach (var announcement in analysisResult.CompanyAnnouncements)
                                {
                                    <div class="card mb-2">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="card-title mb-1">@announcement.Title</h6>
                                                    <p class="card-text small mb-1">@announcement.Content</p>
                                                    <small class="text-muted">
                                                        @announcement.StockCode (@announcement.CompanyName) - 
                                                        @announcement.PublishedDate.ToString("yyyy-MM-dd") - 
                                                        @announcement.AnnouncementType
                                                    </small>
                                                </div>
                                                <span class="badge @(announcement.Priority == "é«˜" ? "bg-danger" : "bg-secondary")">
                                                    @announcement.Priority
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
            
            <!-- åŸæœ‰çš„å ±è¡¨é¡¯ç¤º -->
            @if (pageConfig != null)
            {
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>@pageConfig.PageTitle</h4>
                        <small class="text-muted">ç”Ÿæˆæ™‚é–“: @pageConfig.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</small>
                    </div>
                    <div class="card-body">
                        @if (pageConfig.DataResponses.Any())
                        {
                            <!-- è³‡æ–™æºç‹€æ…‹é¡¯ç¤º -->
                            <div class="mb-4">
                                <h6>ğŸ“¡ è³‡æ–™æºç‹€æ…‹</h6>
                                <div class="row">
                                    @foreach (var response in pageConfig.DataResponses)
                                    {
                                        <div class="col-md-4 mb-2">
                                            <div class="alert @(response.IsSuccess ? "alert-success" : "alert-danger") py-2">
                                                <small>
                                                    @if (response.IsSuccess)
                                                    {
                                                        <span>âœ…</span>
                                                    }
                                                    else
                                                    {
                                                        <span>âŒ</span>
                                                    }
                                                    @string.Join(", ", response.Messages)
                                                </small>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                            
                            <!-- å‹•æ…‹ç”Ÿæˆçš„è¼¸å‡ºå…ƒä»¶ -->
                            @foreach (var component in pageConfig.OutputComponents)
                            {
                                <div class="mb-4">
                                    @foreach (var dataResponse in pageConfig.DataResponses)
                                    {
                                        @component.RenderComponent(dataResponse)
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted py-5">
                                <div style="font-size: 3rem;">ğŸ“Š</div>
                                <h5>è«‹è¨­å®šåƒæ•¸ä¸¦ç”Ÿæˆå ±è¡¨</h5>
                                <p>é¸æ“‡æ‰€éœ€çš„è³‡æ–™ä¾†æºå’Œè¼¸å‡ºå…ƒä»¶ï¼Œç„¶å¾Œé»æ“Šã€Œç”Ÿæˆå ±è¡¨ã€æŒ‰éˆ•</p>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body text-center text-muted py-5">
                        <div style="font-size: 3rem;">ğŸ“‹</div>
                        <h5>Oracleè³‡æ–™åº«é‡‘èè³‡è¨Šæ‘˜è¦ç³»çµ±</h5>
                        <p>ä½¿ç”¨å·¦å´é¢æ¿è¨­å®šæ‚¨çš„éœ€æ±‚ï¼Œç³»çµ±å°‡è‡ªå‹•çµ„åˆé©ç•¶çš„è³‡æ–™è¡¨å’Œé¡¯ç¤ºå…ƒä»¶</p>
                        <hr />
                        <div class="row">
                            <div class="col-md-6">
                                <h6>ğŸ¯ åŠŸèƒ½ç‰¹è‰²</h6>
                                <ul class="list-unstyled text-start">
                                    <li>âœ… ç­–ç•¥æ¨¡å¼è³‡æ–™æº</li>
                                    <li>âœ… å·¥å» æ¨¡å¼é é¢çµ„åˆ</li>
                                    <li>âœ… å‹•æ…‹å…ƒä»¶ç”Ÿæˆ</li>
                                    <li>âœ… å¤šè³‡æ–™æºæ•´åˆ</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>ğŸ“Š æ”¯æ´è³‡æ–™è¡¨</h6>
                                <ul class="list-unstyled text-start">
                                    <li><i class="bi bi-person-badge text-primary"></i> å“¡å·¥è³‡æ–™ (EMPLOYEES)</li>
                                    <li><i class="bi bi-currency-dollar text-success"></i> è²¡å‹™è¨˜éŒ„ (FINANCIAL_RECORDS)</li>
                                    <li><i class="bi bi-megaphone text-warning"></i> å…¬å¸é‡è¨Š (COMPANY_ANNOUNCEMENTS)</li>
                                </ul>
                            </div>
                        </div>
                        <hr />
                        <div class="row">
                            <div class="col-12">
                                <h6>ğŸ’¡ æŸ¥è©¢ç¯„ä¾‹</h6>
                                <div class="text-start">
                                    <p><strong>ç¯„ä¾‹ 1 - æŸ¥è©¢ç‰¹å®šå“¡å·¥:</strong></p>
                                    <small class="text-muted">
                                        â€¢ å“¡å·¥è™Ÿç¢¼: E001<br/>
                                        â€¢ å€åŸŸ: å°åŒ—<br/>
                                        â€¢ å‹¾é¸: å“¡å·¥è³‡æ–™ + è³‡æ–™è¡¨æ ¼
                                    </small>
                                    
                                    <p class="mt-3"><strong>ç¯„ä¾‹ 2 - æŸ¥çœ‹è²¡å‹™è¨˜éŒ„:</strong></p>
                                    <small class="text-muted">
                                        â€¢ å€åŸŸ: æ–°ç«¹<br/>
                                        â€¢ é–‹å§‹æ—¥æœŸ: 2024-01-01<br/>
                                        â€¢ çµæŸæ—¥æœŸ: 2024-12-31<br/>
                                        â€¢ å‹¾é¸: è²¡å‹™è¨˜éŒ„ + SQLæŸ¥è©¢ + è³‡æ–™è¡¨æ ¼
                                    </small>
                                    
                                    <p class="mt-3"><strong>ç¯„ä¾‹ 3 - æŸ¥çœ‹å…¬å¸é‡è¨Š:</strong></p>
                                    <small class="text-muted">
                                        â€¢ é–‹å§‹æ—¥æœŸ: 2024-06-01<br/>
                                        â€¢ çµæŸæ—¥æœŸ: 2024-07-31<br/>
                                        â€¢ æç¤ºè©: é¡¯ç¤ºæœ€æ–°çš„å…¬å¸å…¬å‘Š<br/>
                                        â€¢ å‹¾é¸: å…¬å¸é‡è¨Š + æ‘˜è¦å ±å‘Š
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private FinancialDataRequest request = new();
    private PageConfiguration? pageConfig;
    private EmployeeFinancialAnalysisResult? analysisResult;
    private bool isGenerating = false;
    private string testResults = string.Empty;
    
    // é¸æ“‡ç‹€æ…‹
    private bool employeeSelected = false;
    private bool financialSelected = false;
    private bool announcementSelected = false;
    private bool sqlSelected = false;
    private bool tableSelected = false;
    private bool chartSelected = false;
    private bool summarySelected = false;
    
    protected override async Task OnInitializedAsync()
    {
        // è¨­å®šé è¨­çš„ç¯„ä¾‹æ—¥æœŸç¯„åœ
        request.StartDate = new DateTime(2020, 1, 1);
        request.EndDate = new DateTime(2024, 12, 31);
        await Task.CompletedTask;
    }

    private async Task GenerateReport()
    {
        // æ¸…ç©ºä¹‹å‰çš„é¸æ“‡
        request.DataSources.Clear();
        request.OutputComponents.Clear();
        
        // æ ¹æ“šé¸æ“‡ç‹€æ…‹è¨­å®šè³‡æ–™è¡¨
        if (employeeSelected) request.DataSources.Add("å“¡å·¥è³‡æ–™");
        if (financialSelected) request.DataSources.Add("è²¡å‹™è¨˜éŒ„");
        if (announcementSelected) request.DataSources.Add("å…¬å¸å…¬å‘Š");
        
        // æ ¹æ“šé¸æ“‡ç‹€æ…‹è¨­å®šè¼¸å‡ºå…ƒä»¶
        if (sqlSelected) request.OutputComponents.Add("SQLæŸ¥è©¢");
        if (tableSelected) request.OutputComponents.Add("è³‡æ–™è¡¨æ ¼");
        if (chartSelected) request.OutputComponents.Add("åœ–è¡¨");
        if (summarySelected) request.OutputComponents.Add("æ‘˜è¦å ±å‘Š");
        
        if (!request.DataSources.Any() || !request.OutputComponents.Any())
        {
            return;
        }

        isGenerating = true;
        StateHasChanged();

        try
        {
            // å¦‚æœæä¾›äº†å“¡å·¥IDï¼Œä½¿ç”¨æ–°çš„åˆ†ææœå‹™
            if (!string.IsNullOrEmpty(request.EmployeeId))
            {
                analysisResult = await FinancialAnalysisService.GenerateEmployeeFinancialAnalysisAsync(request);
            }
            
            // åŒæ™‚ä½¿ç”¨åŸæœ‰çš„é é¢å·¥å» ä¾†ç”Ÿæˆå ±è¡¨
            pageConfig = await PageFactory.CreatePageAsync(request);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ ç”Ÿæˆå ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}");
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task TestDataSources()
    {
        isGenerating = true;
        testResults = string.Empty;
        StateHasChanged();
        
        try
        {
            var employeeId = string.IsNullOrEmpty(request.EmployeeId) ? "E001" : request.EmployeeId;
            testResults = await OracleSimulationService.TestDataSourceQueriesAsync(employeeId);
        }
        catch (Exception ex)
        {
            testResults = $"âŒ æ¸¬è©¦å¤±æ•—: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }
}
