@page "/oracle-test"
@rendermode InteractiveServer
@using blazor_strategy_and_factory.Data
@using blazor_strategy_and_factory.Services
@using Microsoft.EntityFrameworkCore
@inject FinancialDbContext DbContext
@inject IConfiguration Configuration
@inject OracleSimulationService OracleSimulation
@inject IJSRuntime JSRuntime

<PageTitle>Oracleè³‡æ–™åº«æ¸¬è©¦</PageTitle>

<div class="container mt-4">
    <h1>ğŸ—„ï¸ Oracleè³‡æ–™åº«é€£ç·šæ¸¬è©¦</h1>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>è³‡æ–™åº«é€£ç·šè³‡è¨Š</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>ç›®å‰è¨­å®š</h6>
                            <ul class="list-unstyled">
                                <li><strong>ä½¿ç”¨Oracle:</strong> @(useOracle ? "æ˜¯" : "å¦ (InMemory)")</li>
                                <li><strong>æ¨¡æ“¬æ¨¡å¼:</strong> @(Configuration.GetValue<bool>("SimulationMode", false) ? "æ˜¯" : "å¦")</li>
                                <li><strong>è³‡æ–™åº«æä¾›è€…:</strong> @databaseProvider</li>
                                <li><strong>é€£ç·šå­—ä¸²:</strong> @(connectionString ?? "N/A")</li>
                                <li><strong>æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹:</strong> <span class="badge bg-success">æ­£å¸¸é‹è¡Œ</span></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>æ“ä½œ</h6>
                            <div class="alert alert-info">
                                <small>
                                    <strong>æ³¨æ„ï¼š</strong> å¦‚æœçœ‹åˆ°Chromeæ“´å±•ç¨‹å¼ç›¸é—œçš„éŒ¯èª¤è¨Šæ¯ï¼Œé€™äº›æ˜¯ç€è¦½å™¨æ“´å±•ç¨‹å¼çš„å•é¡Œï¼Œ
                                    ä¸æœƒå½±éŸ¿æˆ‘å€‘çš„Blazoræ‡‰ç”¨ç¨‹å¼åŠŸèƒ½ã€‚
                                </small>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" 
                                        @onclick="HandleTestConnection" 
                                        type="button">
                                    ğŸ”— æ¸¬è©¦é€£ç·š
                                </button>
                                <button class="btn btn-info" 
                                        @onclick="HandleCheckMigrations" 
                                        disabled="@isLoading"
                                        type="button">
                                    ğŸ“‹ æª¢æŸ¥Migrations
                                </button>
                                <button class="btn btn-warning" 
                                        @onclick="HandleCreateMigration" 
                                        disabled="@isLoading"
                                        type="button">
                                    ğŸ“ å»ºç«‹Migration
                                </button>
                                <button class="btn btn-success" 
                                        @onclick="HandleApplyMigrations" 
                                        disabled="@isLoading"
                                        type="button">
                                    âš¡ å¥—ç”¨Migrations
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>æ¸¬è©¦çµæœ</h5>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>æ­£åœ¨æ¸¬è©¦...</p>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(testResult))
                    {
                        <div class="alert @(isSuccess ? "alert-success" : "alert-danger")" role="alert">
                            <h6>@(isSuccess ? "âœ… æˆåŠŸ" : "âŒ éŒ¯èª¤")</h6>
                            <pre>@testResult</pre>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Oracle SQL è…³æœ¬ç”Ÿæˆå™¨</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-primary" 
                            @onclick="GenerateCreateScript" 
                            disabled="@isLoading"
                            type="button">
                        ğŸ“ ç”Ÿæˆå»ºè¡¨è…³æœ¬
                    </button>
                    @if (!string.IsNullOrEmpty(sqlScript))
                    {
                        <div class="mt-3">
                            <h6>Oracleå»ºè¡¨è…³æœ¬ï¼š</h6>
                            <div class="border p-3 bg-light">
                                <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px;">@sqlScript</pre>
                            </div>
                            <button class="btn btn-sm btn-secondary mt-2" 
                                    @onclick="CopyToClipboard" 
                                    type="button">
                                ğŸ“‹ è¤‡è£½åˆ°å‰ªè²¼ç°¿
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <button class="btn btn-primary" @onclick="SimpleTest">æ¸¬è©¦æŒ‰éˆ•</button>
    <button class="btn btn-primary" @onclick="HandleTestConnectionSimple">ğŸ”— æ¸¬è©¦é€£ç·š (ç°¡å–®ç‰ˆ)</button>
</div>

@code {
    private bool isLoading = false;
    private string testResult = "";
    private bool isSuccess = false;
    private bool useOracle = false;
    private string databaseProvider = "";
    private string? connectionString = "";
    private string sqlScript = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine("OracleTest é é¢åˆå§‹åŒ–é–‹å§‹");
            
            useOracle = Configuration.GetValue<bool>("UseOracleDatabase", false);
            connectionString = Configuration.GetConnectionString("DefaultConnection");
            databaseProvider = DbContext.Database.ProviderName ?? "Unknown";
            
            Console.WriteLine($"åˆå§‹åŒ–å®Œæˆ - UseOracle: {useOracle}, SimulationMode: {Configuration.GetValue<bool>("SimulationMode", false)}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"åˆå§‹åŒ–éŒ¯èª¤: {ex.Message}");
        }
    }

    // åŒ…è£æ–¹æ³•ï¼Œæä¾›é¡å¤–çš„éŒ¯èª¤è™•ç†
    private async Task HandleTestConnection()
    {
        Console.WriteLine("ğŸ”¥ HandleTestConnection è¢«èª¿ç”¨ï¼");
        
        if (isLoading)
        {
            Console.WriteLine("â³ æ­£åœ¨è¼‰å…¥ä¸­ï¼Œå¿½ç•¥é‡è¤‡é»æ“Š");
            return;
        }

        try
        {
            Console.WriteLine("âœ… é–‹å§‹åŸ·è¡Œæ¸¬è©¦é€£ç·š");
            isLoading = true;
            StateHasChanged();
            
            await TestConnection();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ HandleTestConnection éŒ¯èª¤: {ex.Message}");
            testResult = $"âŒ æŒ‰éˆ•è™•ç†éŒ¯èª¤: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleCheckMigrations()
    {
        Console.WriteLine("ğŸ” HandleCheckMigrations è¢«èª¿ç”¨");
        if (isLoading) return;
        
        try
        {
            isLoading = true;
            StateHasChanged();
            await CheckMigrations();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ HandleCheckMigrations éŒ¯èª¤: {ex.Message}");
            testResult = $"âŒ æª¢æŸ¥ Migrations éŒ¯èª¤: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleCreateMigration()
    {
        Console.WriteLine("ğŸ“ HandleCreateMigration è¢«èª¿ç”¨");
        if (isLoading) return;
        
        try
        {
            isLoading = true;
            StateHasChanged();
            await CreateMigration();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ HandleCreateMigration éŒ¯èª¤: {ex.Message}");
            testResult = $"âŒ å»ºç«‹ Migration éŒ¯èª¤: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleApplyMigrations()
    {
        Console.WriteLine("âš¡ HandleApplyMigrations è¢«èª¿ç”¨");
        if (isLoading) return;
        
        try
        {
            isLoading = true;
            StateHasChanged();
            await ApplyMigrations();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ HandleApplyMigrations éŒ¯èª¤: {ex.Message}");
            testResult = $"âŒ å¥—ç”¨ Migrations éŒ¯èª¤: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task TestConnection()
    {
        Console.WriteLine("ğŸš€ TestConnection æ–¹æ³•é–‹å§‹");
        
        try
        {
            testResult = "";
            StateHasChanged();
            
            var simulationMode = Configuration.GetValue<bool>("SimulationMode", false);
            Console.WriteLine($"ğŸ“‹ æ¨¡æ“¬æ¨¡å¼: {simulationMode}");
            
            Console.WriteLine("ğŸ”— æ­£åœ¨èª¿ç”¨ OracleSimulation.TestOracleConnectionAsync()...");
            var canConnect = await OracleSimulation.TestOracleConnectionAsync();
            Console.WriteLine($"ğŸ“Š é€£ç·šæ¸¬è©¦çµæœ: {canConnect}");
            
            if (canConnect)
            {
                testResult = $"âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸï¼\n" +
                           $"æ¨¡å¼: {(simulationMode ? "æ¨¡æ“¬æ¨¡å¼" : "å¯¦éš›é€£ç·š")}\n" +
                           $"æä¾›è€…: {DbContext.Database.ProviderName}\n" +
                           $"é€£ç·šå­—ä¸²: {connectionString}\n" +
                           $"æ¸¬è©¦æ™‚é–“: {DateTime.Now:yyyy-MM-dd HH:mm:ss}";
                isSuccess = true;
                Console.WriteLine("âœ… é€£ç·šæ¸¬è©¦æˆåŠŸ");
            }
            else
            {
                testResult = "âŒ ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«";
                isSuccess = false;
                Console.WriteLine("âŒ é€£ç·šæ¸¬è©¦å¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ğŸ’¥ TestConnection ç•°å¸¸: {ex.Message}");
            testResult = $"âŒ é€£ç·šæ¸¬è©¦éŒ¯èª¤:\n{ex.Message}\néŒ¯èª¤é¡å‹: {ex.GetType().Name}";
            isSuccess = false;
        }
        
        Console.WriteLine("ğŸ TestConnection æ–¹æ³•çµæŸ");
        StateHasChanged();
    }

    private async Task CheckMigrations()
    {
        isLoading = true;
        testResult = "";
        StateHasChanged();

        try
        {
            var simulationMode = Configuration.GetValue<bool>("SimulationMode", false);
            var pendingMigrations = await OracleSimulation.GetPendingMigrationsAsync();
            
            if (simulationMode)
            {
                testResult = $"ğŸ“‹ Migrationç‹€æ…‹ (æ¨¡æ“¬æ¨¡å¼):\n\n" +
                            $"å¾…å¥—ç”¨çš„Migrations:\n" +
                            string.Join("\n", pendingMigrations.Select(m => $"  â³ {m}")) + "\n\n" +
                            $"æ³¨æ„ï¼šé€™æ˜¯æ¨¡æ“¬æ¨¡å¼ï¼Œå¯¦éš›migrationç‹€æ…‹è«‹é€£ç·šåˆ°çœŸå¯¦Oracleè³‡æ–™åº«æŸ¥çœ‹ã€‚";
            }
            else
            {
                var appliedMigrations = await DbContext.Database.GetAppliedMigrationsAsync();
                testResult = $"ğŸ“‹ Migrationç‹€æ…‹:\n\n" +
                            $"å·²å¥—ç”¨çš„Migrations ({appliedMigrations.Count()}):\n" +
                            string.Join("\n", appliedMigrations.Select(m => $"  âœ… {m}")) + "\n\n" +
                            $"å¾…å¥—ç”¨çš„Migrations ({pendingMigrations.Count()}):\n" +
                            string.Join("\n", pendingMigrations.Select(m => $"  â³ {m}"));

                if (!pendingMigrations.Any())
                {
                    testResult += "\n\nâœ… æ‰€æœ‰Migrationséƒ½å·²å¥—ç”¨ï¼";
                }
            }

            isSuccess = true;
        }
        catch (Exception ex)
        {
            testResult = $"âŒ æª¢æŸ¥Migrationæ™‚ç™¼ç”ŸéŒ¯èª¤:\n{ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CreateMigration()
    {
        isLoading = true;
        testResult = "";
        StateHasChanged();

        try
        {
            var (success, output) = await OracleSimulation.CreateMigrationAsync("NewMigration");
            testResult = output;
            isSuccess = success;
        }
        catch (Exception ex)
        {
            testResult = $"âŒ å»ºç«‹ Migration æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ApplyMigrations()
    {
        isLoading = true;
        testResult = "";
        StateHasChanged();

        try
        {
            var (success, output) = await OracleSimulation.ApplyMigrationsAsync();
            testResult = output;
            isSuccess = success;
        }
        catch (Exception ex)
        {
            testResult = $"âŒ å¥—ç”¨ Migration æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GenerateCreateScript()
    {
        isLoading = true;
        testResult = "";
        sqlScript = "";
        StateHasChanged();

        try
        {
            sqlScript = await OracleSimulation.GenerateCreateScriptAsync();
            if (!string.IsNullOrEmpty(sqlScript))
            {
                testResult = "âœ… Oracle å»ºè¡¨è…³æœ¬å·²æˆåŠŸç”Ÿæˆã€‚";
                isSuccess = true;
            }
            else
            {
                testResult = "âŒ ç„¡æ³•ç”Ÿæˆ SQL è…³æœ¬ã€‚";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            testResult = $"âŒ ç”Ÿæˆè…³æœ¬æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CopyToClipboard()
    {
        if (!string.IsNullOrEmpty(sqlScript))
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", sqlScript);
                testResult = "âœ… SQL è…³æœ¬å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼";
                isSuccess = true;
            }
            catch (Exception ex)
            {
                testResult = $"âŒ è¤‡è£½å¤±æ•—: {ex.Message}";
                isSuccess = false;
            }
        }
        else
        {
            testResult = "âŒ æ²’æœ‰å¯è¤‡è£½çš„ SQL è…³æœ¬ã€‚è«‹å…ˆç”Ÿæˆè…³æœ¬ã€‚";
            isSuccess = false;
        }
        StateHasChanged();
    }

    private void SimpleTest()
    {
        Console.WriteLine("ğŸš© æŒ‰éˆ•äº‹ä»¶å·²è§¸ç™¼ï¼");
    }

    private async Task HandleTestConnectionSimple()
    {
        Console.WriteLine("ğŸ”¥ ç°¡å–®ç‰ˆæ¸¬è©¦é€£ç·šæŒ‰éˆ•è¢«é»æ“Šï¼");
        testResult = "âœ… æŒ‰éˆ•å·²è§¸ç™¼ï¼";
        isSuccess = true;
        await InvokeAsync(StateHasChanged);
    }
}
