@page "/system-test"
@rendermode InteractiveServer
@using blazor_strategy_and_factory.Models
@using blazor_strategy_and_factory.Services.Factory
@using blazor_strategy_and_factory.Services.DataSources
@using blazor_strategy_and_factory.Services.OutputComponents
@using blazor_strategy_and_factory.Services
@inject IPageFactory PageFactory
@inject IDataSourceService DataSourceService
@inject IOutputComponentService OutputComponentService
@implements IDisposable

<PageTitle>ç³»çµ±æ¸¬è©¦</PageTitle>

<div class="container mt-4">
    <h1>ğŸ§ª ç³»çµ±æ¸¬è©¦é é¢</h1>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>æ¸¬è©¦çµæœ</h5>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>æ­£åœ¨æ¸¬è©¦ç³»çµ±...</p>
                        </div>
                    }
                    else if (testResults.Any())
                    {
                        <div class="accordion" id="testResultsAccordion">
                            @for (int i = 0; i < testResults.Count; i++)
                            {
                                var result = testResults[i];
                                var uniqueId = $"test-{i}";
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading-@uniqueId">
                                        <button class="accordion-button @(result.IsSuccess ? "" : "collapsed")" 
                                                type="button" 
                                                data-bs-toggle="collapse" 
                                                data-bs-target="#collapse-@uniqueId" 
                                                aria-expanded="@(result.IsSuccess ? "true" : "false")" 
                                                aria-controls="collapse-@uniqueId">
                                            @(result.IsSuccess ? "âœ…" : "âŒ") @result.TestName
                                        </button>
                                    </h2>
                                    <div id="collapse-@uniqueId" 
                                         class="accordion-collapse collapse @(result.IsSuccess ? "show" : "")" 
                                         aria-labelledby="heading-@uniqueId" 
                                         data-bs-parent="#testResultsAccordion">
                                        <div class="accordion-body">
                                            <strong>æ¸¬è©¦çµæœï¼š</strong> @result.Message
                                            @if (result.Details != null)
                                            {
                                                <div class="mt-2">
                                                    <strong>è©³ç´°è³‡è¨Šï¼š</strong>
                                                    <pre><code>@result.Details</code></pre>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center">
                            <button class="btn btn-primary" @onclick="RunTests">
                                ğŸš€ é–‹å§‹æ¸¬è©¦
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool isLoading = false;
    private List<TestResult> testResults = new();
    private CancellationTokenSource? cancellationTokenSource;
    
    public class TestResult
    {
        public string TestName { get; set; } = "";
        public bool IsSuccess { get; set; }
        public string Message { get; set; } = "";
        public string? Details { get; set; }
    }
    
    private async Task RunTests()
    {
        if (isLoading) return; // é˜²æ­¢é‡è¤‡åŸ·è¡Œ
        
        cancellationTokenSource?.Cancel();
        cancellationTokenSource = new CancellationTokenSource();
        
        isLoading = true;
        testResults.Clear();
        StateHasChanged();
        
        try
        {
            // æ¸¬è©¦è³‡æ–™æºç­–ç•¥
            await TestDataSourceStrategies(cancellationTokenSource.Token);
            
            // æ¸¬è©¦å·¥å» æ¨¡å¼
            await TestFactoryPattern(cancellationTokenSource.Token);
        }
        catch (OperationCanceledException)
        {
            // æ¸¬è©¦è¢«å–æ¶ˆ
        }
        catch (Exception ex)
        {
            testResults.Add(new TestResult
            {
                TestName = "ç³»çµ±éŒ¯èª¤",
                IsSuccess = false,
                Message = "æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤",
                Details = ex.Message
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task TestDataSourceStrategies(CancellationToken cancellationToken = default)
    {
        var request = new FinancialDataRequest
        {
            // ç§»é™¤éæ¿¾æ¢ä»¶ï¼Œä»¥ä¾¿æ¸¬è©¦æ‰€æœ‰è³‡æ–™
            // Region = "å°åŒ—",
            // StartDate = DateTime.Now.AddDays(-30),
            // EndDate = DateTime.Now
        };
        
        var dataSourceNames = new[] { "å“¡å·¥è³‡æ–™", "è²¡å‹™è¨˜éŒ„", "å…¬å¸å…¬å‘Š" };
        
        foreach (var dataSourceName in dataSourceNames)
        {
            cancellationToken.ThrowIfCancellationRequested();
            
            try
            {
                var strategy = DataSourceService.GetStrategy(dataSourceName);
                if (strategy != null)
                {
                    var result = await strategy.FetchDataAsync(request);
                    
                    // æ ¹æ“šä¸åŒçš„è³‡æ–™æºé¡å‹ï¼Œæ­£ç¢ºè¨ˆç®—è³‡æ–™ç­†æ•¸
                    var dataCount = 0;
                    if (result.IsSuccess)
                    {
                        if (result.Data.ContainsKey("RecordCount"))
                        {
                            dataCount = (int)result.Data["RecordCount"];
                        }
                        else if (result.Data.ContainsKey("Employees"))
                        {
                            var employees = result.Data["Employees"] as IEnumerable<object>;
                            dataCount = employees?.Count() ?? 0;
                        }
                        else if (result.Data.ContainsKey("Records"))
                        {
                            var records = result.Data["Records"] as IEnumerable<object>;
                            dataCount = records?.Count() ?? 0;
                        }
                        else if (result.Data.ContainsKey("Announcements"))
                        {
                            var announcements = result.Data["Announcements"] as IEnumerable<object>;
                            dataCount = announcements?.Count() ?? 0;
                        }
                    }
                    
                    testResults.Add(new TestResult
                    {
                        TestName = $"è³‡æ–™æºæ¸¬è©¦ - {dataSourceName}",
                        IsSuccess = result.IsSuccess,
                        Message = result.IsSuccess ? "æ¸¬è©¦æˆåŠŸ" : "æ¸¬è©¦å¤±æ•—",
                        Details = result.IsSuccess ? 
                            $"æŸ¥è©¢åˆ°è³‡æ–™: {dataCount} ç­†" : 
                            string.Join(", ", result.Messages)
                    });
                }
                else
                {
                    testResults.Add(new TestResult
                    {
                        TestName = $"è³‡æ–™æºæ¸¬è©¦ - {dataSourceName}",
                        IsSuccess = false,
                        Message = "æ¸¬è©¦å¤±æ•—",
                        Details = "ç„¡æ³•å–å¾—è³‡æ–™æºç­–ç•¥"
                    });
                }
            }
            catch (Exception ex)
            {
                testResults.Add(new TestResult
                {
                    TestName = $"è³‡æ–™æºæ¸¬è©¦ - {dataSourceName}",
                    IsSuccess = false,
                    Message = "æ¸¬è©¦å¤±æ•—",
                    Details = ex.Message
                });
            }
        }
    }
    
    private async Task TestFactoryPattern(CancellationToken cancellationToken = default)
    {
        try
        {
            var request = new FinancialDataRequest
            {
                Region = "å°åŒ—",
                StartDate = DateTime.Now.AddDays(-30),
                EndDate = DateTime.Now
            };
            
            var pageConfig = await PageFactory.CreatePageAsync(request);
            
            testResults.Add(new TestResult
            {
                TestName = "å·¥å» æ¨¡å¼æ¸¬è©¦",
                IsSuccess = true,
                Message = "å·¥å» æ¨¡å¼æ¸¬è©¦æˆåŠŸ",
                Details = $"æˆåŠŸå‰µå»ºé é¢é…ç½®ï¼ŒåŒ…å« {pageConfig.DataSources.Count} å€‹è³‡æ–™æºå’Œ {pageConfig.OutputComponents.Count} å€‹è¼¸å‡ºå…ƒä»¶"
            });
        }
        catch (Exception ex)
        {
            testResults.Add(new TestResult
            {
                TestName = "å·¥å» æ¨¡å¼æ¸¬è©¦",
                IsSuccess = false,
                Message = "å·¥å» æ¨¡å¼æ¸¬è©¦å¤±æ•—",
                Details = ex.Message
            });
        }
    }
    
    public void Dispose()
    {
        cancellationTokenSource?.Cancel();
        cancellationTokenSource?.Dispose();
    }
}
